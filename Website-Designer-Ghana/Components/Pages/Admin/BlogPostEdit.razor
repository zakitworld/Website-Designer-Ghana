@page "/admin/blog-posts/create"
@page "/admin/blog-posts/edit/{id:int}"
@using Microsoft.AspNetCore.Authorization
@using Website_Designer_Ghana.Services.Interfaces
@using Website_Designer_Ghana.Data.Models
@using System.ComponentModel.DataAnnotations
@attribute [Authorize(Roles = "Admin")]
@layout AdminLayout

<PageTitle>@(Id.HasValue ? "Edit" : "Create") Blog Post - Admin</PageTitle>

<div class="blog-post-edit">
    <div class="row mb-4">
        <div class="col">
            <h2 class="mb-0">@(Id.HasValue ? "Edit" : "Create") Blog Post</h2>
            <p class="text-muted">@(Id.HasValue ? "Update" : "Write") your blog post</p>
        </div>
        <div class="col-auto">
            <a href="/admin/blog-posts" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>
                Back to Posts
            </a>
        </div>
    </div>

    <div class="card border-0 shadow-sm">
        <div class="card-body p-4">
            <EditForm Model="@model" OnValidSubmit="@HandleSubmit">
                <DataAnnotationsValidator />

                <div class="row g-4">
                    <div class="col-12">
                        <label class="form-label">Title</label>
                        <InputText @bind-Value="model.Title" class="form-control" placeholder="Enter post title" />
                        <ValidationMessage For="@(() => model.Title)" class="text-danger" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Slug (URL)</label>
                        <InputText @bind-Value="model.Slug" class="form-control" placeholder="blog-post-url" />
                        <small class="form-text text-muted">URL-friendly version of the title</small>
                        <ValidationMessage For="@(() => model.Slug)" class="text-danger" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Category</label>
                        <InputSelect @bind-Value="model.CategoryId" class="form-select">
                            <option value="">Select a category</option>
                            @if (categories != null)
                            {
                                @foreach (var category in categories)
                                {
                                    <option value="@category.Id">@category.Name</option>
                                }
                            }
                        </InputSelect>
                    </div>

                    <div class="col-12">
                        <label class="form-label">Summary</label>
                        <InputTextArea @bind-Value="model.Summary" class="form-control" rows="3"
                            placeholder="Brief summary of the post" />
                        <ValidationMessage For="@(() => model.Summary)" class="text-danger" />
                    </div>

                    <div class="col-12">
                        <label class="form-label">Content (HTML)</label>
                        <InputTextArea @bind-Value="model.Content" class="form-control" rows="15"
                            placeholder="Enter post content (HTML supported)" />
                        <ValidationMessage For="@(() => model.Content)" class="text-danger" />
                    </div>

                    <div class="col-12">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Featured Image URL</label>
                                <InputText @bind-Value="model.FeaturedImage" class="form-control"
                                    placeholder="https://example.com/image.jpg or upload below" />
                            </div>
                            <div class="col-md-6">
                                <FileUpload Label="Or Upload Featured Image"
                                    Accept="image/*"
                                    ImagesOnly="true"
                                    Folder="blog"
                                    MaxFileSizeInMB="5"
                                    OnFileUploaded="@HandleImageUploaded" />
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Author</label>
                        <InputText @bind-Value="model.Author" class="form-control" placeholder="Author name" />
                        <ValidationMessage For="@(() => model.Author)" class="text-danger" />
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Meta Title (SEO)</label>
                        <InputText @bind-Value="model.MetaTitle" class="form-control" placeholder="SEO title" />
                    </div>

                    <div class="col-md-8">
                        <label class="form-label">Meta Description (SEO)</label>
                        <InputText @bind-Value="model.MetaDescription" class="form-control"
                            placeholder="SEO description" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Meta Keywords (SEO)</label>
                        <InputText @bind-Value="model.MetaKeywords" class="form-control"
                            placeholder="keyword1, keyword2, keyword3" />
                    </div>

                    <div class="col-md-6">
                        <div class="form-check mt-4 pt-2">
                            <InputCheckbox @bind-Value="model.IsPublished" class="form-check-input" id="isPublished" />
                            <label class="form-check-label" for="isPublished">
                                Publish this post
                            </label>
                        </div>
                    </div>

                    <div class="col-12">
                        <hr />
                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-outline-secondary" @onclick="Cancel">
                                Cancel
                            </button>
                            <button type="submit" class="btn btn-secondary" disabled="@isSaving">
                                @if (isSaving)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                }
                                <i class="bi bi-check-circle me-2"></i>
                                @(Id.HasValue ? "Update" : "Create") Post
                            </button>
                        </div>
                    </div>
                </div>
            </EditForm>
        </div>
    </div>
</div>

@code {
    [Parameter] public int? Id { get; set; }
    [Inject] private IBlogService BlogService { get; set; } = default!;
    [Inject] private NavigationManager NavigationManager { get; set; } = default!;

    private BlogPostFormModel model = new();
    private IEnumerable<BlogCategory>? categories;
    private bool isSaving = false;

    private void HandleImageUploaded(string filePath)
    {
        model.FeaturedImage = filePath;
    }

    protected override async Task OnInitializedAsync()
    {
        categories = await BlogService.GetAllCategoriesAsync();

        if (Id.HasValue)
        {
            var post = await BlogService.GetPostByIdAsync(Id.Value);
            if (post != null)
            {
                model = new BlogPostFormModel
                    {
                        Title = post.Title,
                        Slug = post.Slug,
                        Summary = post.Summary,
                        Content = post.Content,
                        FeaturedImage = post.FeaturedImage,
                        Author = post.Author,
                        CategoryId = post.CategoryId,
                        IsPublished = post.IsPublished,
                        MetaTitle = post.MetaTitle,
                        MetaDescription = post.MetaDescription,
                        MetaKeywords = post.MetaKeywords
                    };
            }
        }
        else
        {
            model.Author = "Website Designer Ghana Team";
        }
    }

    private async Task HandleSubmit()
    {
        isSaving = true;
        try
        {
            if (Id.HasValue)
            {
                var post = await BlogService.GetPostByIdAsync(Id.Value);
                if (post != null)
                {
                    post.Title = model.Title;
                    post.Slug = model.Slug;
                    post.Summary = model.Summary;
                    post.Content = model.Content;
                    post.FeaturedImage = model.FeaturedImage;
                    post.Author = model.Author;
                    post.CategoryId = model.CategoryId;
                    post.IsPublished = model.IsPublished;
                    post.MetaTitle = model.MetaTitle;
                    post.MetaDescription = model.MetaDescription;
                    post.MetaKeywords = model.MetaKeywords;
                    post.UpdatedAt = DateTime.UtcNow;

                    if (model.IsPublished && !post.PublishedAt.HasValue)
                    {
                        post.PublishedAt = DateTime.UtcNow;
                    }

                    await BlogService.UpdatePostAsync(post);
                }
            }
            else
            {
                var post = new BlogPost
                    {
                        Title = model.Title,
                        Slug = model.Slug,
                        Summary = model.Summary,
                        Content = model.Content,
                        FeaturedImage = model.FeaturedImage,
                        Author = model.Author,
                        CategoryId = model.CategoryId,
                        IsPublished = model.IsPublished,
                        MetaTitle = model.MetaTitle,
                        MetaDescription = model.MetaDescription,
                        MetaKeywords = model.MetaKeywords,
                        CreatedAt = DateTime.UtcNow,
                        PublishedAt = model.IsPublished ? DateTime.UtcNow : null,
                        ViewCount = 0
                    };

                await BlogService.CreatePostAsync(post);
            }

            NavigationManager.NavigateTo("/admin/blog-posts");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving blog post: {ex.Message}");
        }
        finally
        {
            isSaving = false;
        }
    }

    private void Cancel()
    {
        NavigationManager.NavigateTo("/admin/blog-posts");
    }

    public class BlogPostFormModel
    {
        [Required(ErrorMessage = "Title is required")]
        [MaxLength(200)]
        public string Title { get; set; } = string.Empty;

        [Required(ErrorMessage = "Slug is required")]
        [MaxLength(250)]
        public string Slug { get; set; } = string.Empty;

        [Required(ErrorMessage = "Summary is required")]
        public string Summary { get; set; } = string.Empty;

        [Required(ErrorMessage = "Content is required")]
        public string Content { get; set; } = string.Empty;

        public string? FeaturedImage { get; set; }

        [Required(ErrorMessage = "Author is required")]
        public string Author { get; set; } = string.Empty;

        public int? CategoryId { get; set; }

        public bool IsPublished { get; set; }

        public string? MetaTitle { get; set; }
        public string? MetaDescription { get; set; }
        public string? MetaKeywords { get; set; }
    }
}
