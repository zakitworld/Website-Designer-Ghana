@page "/admin/contact-submissions"
@using Microsoft.AspNetCore.Authorization
@using Website_Designer_Ghana.Services.Interfaces
@using Website_Designer_Ghana.Data.Models
@attribute [Authorize(Roles = "Admin")]
@layout AdminLayout

<PageTitle>Contact Submissions - Admin</PageTitle>

<div class="contact-submissions-admin">
    <div class="row mb-4">
        <div class="col">
            <h2 class="mb-0">Contact Submissions</h2>
            <p class="text-muted">View and manage contact form submissions</p>
        </div>
    </div>

    <div class="card border-0 shadow-sm">
        <div class="card-body">
            @if (submissions == null)
            {
                <div class="text-center py-5">
                    <div class="spinner-border text-secondary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            }
            else if (!submissions.Any())
            {
                <div class="text-center py-5">
                    <i class="bi bi-inbox fs-1 text-muted"></i>
                    <p class="text-muted mt-3">No contact submissions yet.</p>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Service</th>
                                <th>Status</th>
                                <th>Submitted</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var submission in submissions)
                            {
                                <tr>
                                    <td>@submission.FullName</td>
                                    <td>
                                        <a href="mailto:@submission.Email" class="text-decoration-none">
                                            @submission.Email
                                        </a>
                                    </td>
                                    <td>@(submission.Phone ?? "N/A")</td>
                                    <td>@submission.Subject</td>
                                    <td>
                                        @if (submission.IsRead)
                                        {
                                            <span class="badge bg-success">Read</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-warning text-dark">Unread</span>
                                        }
                                    </td>
                                    <td>@submission.SubmittedAt.ToString("MMM dd, yyyy HH:mm")</td>
                                    <td>
                                        <button type="button" class="btn btn-outline-primary btn-sm"
                                            @onclick="() => ViewSubmission(submission)">
                                            <i class="bi bi-eye"></i> View
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

<!-- View Modal -->
@if (selectedSubmission != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Contact Submission Details</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <strong>Full Name:</strong>
                            <p>@selectedSubmission.FullName</p>
                        </div>
                        <div class="col-md-6">
                            <strong>Email:</strong>
                            <p><a href="mailto:@selectedSubmission.Email">@selectedSubmission.Email</a></p>
                        </div>
                        <div class="col-md-6">
                            <strong>Phone:</strong>
                            <p>@(selectedSubmission.Phone ?? "Not provided")</p>
                        </div>
                        <div class="col-md-6">
                            <strong>Subject:</strong>
                            <p>@selectedSubmission.Subject</p>
                        </div>
                        <div class="col-md-6">
                            <strong>Company:</strong>
                            <p>@(selectedSubmission.Company ?? "Not provided")</p>
                        </div>
                        <div class="col-12">
                            <strong>Message:</strong>
                            <p class="bg-light p-3 rounded">@selectedSubmission.Message</p>
                        </div>
                        <div class="col-md-6">
                            <strong>Submitted:</strong>
                            <p>@selectedSubmission.SubmittedAt.ToString("MMMM dd, yyyy 'at' HH:mm")</p>
                        </div>
                        <div class="col-md-6">
                            <strong>IP Address:</strong>
                            <p>@(selectedSubmission.IpAddress ?? "Unknown")</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseModal">Close</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Inject] private IContactService ContactService { get; set; } = default!;

    private IEnumerable<ContactSubmission>? submissions;
    private ContactSubmission? selectedSubmission;

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        try
        {
            submissions = (await ContactService.GetRecentSubmissionsAsync(100))
                .OrderByDescending(s => s.SubmittedAt);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading contact submissions: {ex.Message}");
            submissions = new List<ContactSubmission>();
        }
    }

    private async Task ViewSubmission(ContactSubmission submission)
    {
        selectedSubmission = submission;

        if (!submission.IsRead)
        {
            try
            {
                await ContactService.MarkAsReadAsync(submission.Id);
                submission.IsRead = true;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error marking submission as read: {ex.Message}");
            }
        }
    }

    private void CloseModal()
    {
        selectedSubmission = null;
    }
}
